<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ray Services - Work Progress</title>
<style>
:root{--bg:#f4f7fb;--card:#fff;--primary:#007bff;--accent:#28a745;--muted:#888;}
body{font-family:Inter,Poppins,sans-serif;background:var(--bg);margin:0;color:#222;}
.wrap{max-width:760px;margin:36px auto;padding:18px;}
.card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(10,20,40,0.06);}
h1{margin:0 0 6px;color:var(--primary);font-size:20px}
p.small{margin:0;color:var(--muted);font-size:13px}
.search{display:flex;gap:8px;margin-top:14px}
input[type="text"], input[type="password"]{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;font-size:15px}
button{padding:10px 14px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--primary),#0a66d6);color:#fff;cursor:pointer}
.result{margin-top:18px}
.meta{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px}
.meta .item{font-size:14px;color:#333}
.progress-wrap{margin-top:8px}
.bar{height:14px;background:#eee;border-radius:999px;overflow:hidden}
.bar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--primary),#ff7a00);transition:width .45s}
.stages{margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
.stage{padding:10px;border-radius:10px;border:1px solid #f0f2f6;background:#fff;display:flex;flex-direction:column;gap:8px}
.stage .name{font-weight:700}
.chip{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:700;font-size:13px}
.pending{background:#fff7e6;color:#8a6a00;border:1px solid #fdeacb}
.inprogress{background:#eaf2ff;color:#0b59d6;border:1px solid #dbe9ff}
.done{background:#e9fbef;color:#1b7a2f;border:1px solid #daf6de}
.note{margin-top:12px;padding:10px;border-radius:8px;background:#f8f9fb;border-left:4px solid #007bff}
.notfound{padding:12px;text-align:center;color:#b00020}
.footer{margin-top:16px;text-align:center;color:#666;font-size:13px}
.adminControls{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
@media(max-width:520px){.stages{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
<div class="card">
<h1>üîç Work Progress ‚Äî Ray Services</h1>
<p class="small">‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§Ø‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§°‡§æ‡§≤‡§ï‡§∞ ‡§Ö‡§™‡§®‡•á ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§ï‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§¶‡•á‡§ñ‡•á‡§Ç</p>

<div class="search">
<input id="q" type="text" placeholder="Name or Mobile number (e.g., chandan OR 9876543210)">
<button id="btn">Check</button>
</div>

<div style="margin-top:12px">
<input id="adminPass" type="password" placeholder="Admin Password (for update)">
<button id="adminBtn" style="margin-top:6px;background:#666">Admin Login</button>
</div>

<div id="out" class="result"></div>
<div class="footer">Developed by <strong>Ray Services</strong></div>
</div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbydq0a0ow7xMLK0z8P-FZSzYCif4GVY05rPuGd6IcN-RWs10OcU1ImKzLZSWTufHZV5/exec";
const btn=document.getElementById('btn');
const adminBtn=document.getElementById('adminBtn');
const q=document.getElementById('q');
const passField=document.getElementById('adminPass');
const out=document.getElementById('out');
let isAdmin=false;
let currentData=null;

btn.addEventListener('click',()=>checkStatus());
q.addEventListener('keyup',e=>{if(e.key==='Enter')checkStatus();});
adminBtn.addEventListener('click',()=>{ if(passField.value==='ray@2025'){isAdmin=true;alert('Admin mode enabled'); checkStatus(); } else alert('Incorrect password!'); });

async function checkStatus(){
  const v=q.value.trim(); if(!v){alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§æ‡§Æ ‡§Ø‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç'); return;}
  out.innerHTML='<div style="padding:10px">‚è≥ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç...</div>';
  try{
    const url=`${API_URL}?name=${encodeURIComponent(v)}&mobile=${encodeURIComponent(v)}`;
    const res=await fetch(url);
    if(!res.ok) throw new Error('Network error');
    const data=await res.json();
    if(data.error){out.innerHTML='<div class="notfound">‚ùå ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</div>'; return;}
    currentData=data;
    render();
  }catch(e){console.error(e); out.innerHTML='<div class="notfound">‚ö†Ô∏è ‡§°‡•á‡§ü‡§æ ‡§≤‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø</div>';}
}

function render(){
  if(!currentData) return;
  const stages=[
    {key:'advance',label:'Advance Payment'},
    {key:'design',label:'Design Approval'},
    {key:'material',label:'Raw Material / Printing'},
    {key:'workshop',label:'Working on Workshop'},
    {key:'testing',label:'Testing'},
    {key:'transport',label:'Ready to Transport'},
    {key:'installation',label:'Final Installation'}
  ];
  let doneCount=0; stages.forEach(s=>{if((currentData[s.key]||'').toLowerCase()==='done')doneCount++;});
  const percent=Math.round((doneCount/stages.length)*100);

  let html=`<div class="meta">
  <div class="item"><strong>${escape(currentData.client_name)}</strong></div>
  <div class="item">Order: ${escape(currentData.order_id)}</div>
  <div class="item">Mobile: ${escape(currentData.mobile_number)}</div>
  <div class="item">Delivery: ${escape(currentData.delivery_date)}</div></div>`;

  html+=`<div class="progress-wrap"><div style="display:flex;justify-content:space-between">
  <div style="font-size:13px;color:#555">Progress</div><div style="font-size:13px;color:#555">${percent}%</div></div>
  <div class="bar" style="margin-top:8px"><i style="width:${percent}%"></i></div></div>`;

  html+='<div class="stages">';
  stages.forEach(s=>{
    let val=(currentData[s.key]||'').toLowerCase(), cls='pending', lbl='Pending';
    if(val==='done'){cls='done'; lbl='Completed';} else if(val==='inprogress'){cls='inprogress'; lbl='In Progress';}
    html+=`<div class="stage"><div class="name">${s.label}</div><div><span class="chip ${cls}">${lbl}</span></div>`;
    if(isAdmin){
      html+=`<div class="adminControls">
        <button onclick="toggleStage('${s.key}')">Toggle</button>
        <button onclick="setInProgress('${s.key}')">In Progress</button>
      </div>`;
    }
    html+='</div>';
  });
  html+='</div>';
  html+=`<div class="note"><strong>Note:</strong> <textarea id="noteArea" style="width:100%;padding:6px">${escape(currentData.note||'')}</textarea></div>
  <div style="margin-top:6px;font-size:12px;color:#666">Last updated: ${escape(currentData.updated||'-')}</div>`;
  if(isAdmin) html+=`<div style="margin-top:8px"><button onclick="saveData()" style="background:#007bff;color:#fff;padding:8px 12px;border-radius:8px">Save Updates</button></div>`;
  html+=whatsappButtonHtml(currentData);
  out.innerHTML=html;
}

function toggleStage(k){if(!currentData) return; currentData[k]=currentData[k]==='done'?'pending':'done'; render();}
function setInProgress(k){if(!currentData) return; currentData[k]='inprogress'; render();}
function saveData(){
  if(!currentData) return;
  currentData.note=document.getElementById('noteArea').value;
  fetch(API_URL,{
    method:'POST',
    body: JSON.stringify(currentData),
    headers:{'Content-Type':'application/json'}
  }).then(r=>r.json()).then(res=>{
    alert(res.message||'Saved to Google Sheet');
  }).catch(err=>{alert('Error saving data');console.error(err);});
}

function whatsappButtonHtml(data){
  if(!data) return '';
  const keys=['advance','design','material','workshop','testing','transport','installation'];
  let lines=['üîî Work Progress Update',`Order: ${data.order_id}`,`Client: ${data.client_name}`,`Delivery: ${data.delivery_date}`,''];
  keys.forEach(k=>{
    let v=(data[k]||'').toLowerCase();
    const emoji=v==='done'?'‚úÖ':v==='inprogress'?'üîÑ':'‚è≥';
    const lbl=v==='done'?'Completed':v==='inprogress'?'In Progress':'Pending';
    lines.push(`${emoji} ${k.replace(/_/g,' ')} ‚Äî ${lbl}`);
  });
  if(data.note) lines.push('',`üìù Note: ${data.note}`);
  return `<div style="margin-top:12px"><a target="_blank" rel="noopener" href="https://wa.me/?text=${encodeURIComponent(lines.join('\n'))}">
  <button style="background:#25D366;color:#fff;padding:8px 12px;border-radius:8px">Share on WhatsApp</button></a></div>`;
}

function escape(str){return String(str||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
</script>
</body>
</html>
